parameters:
  arch: 'x64'

jobs:
  - job: 'Windows_${{ parameters.arch }}'
    pool:
      vmImage: 'windows-2019'

    steps:
    - script: python -m pip install --upgrade pip
    - script: python -m pip install codecov

    - template: setup.yml

    - task: PowerShell@2
      inputs:
        filePath: build\win\install_open_cpp_coverage.ps1
      displayName: 'Dependencies'

    - task: VSBuild@1
      inputs:
        solution: 'build\win\libfly.sln'
        configuration: 'Release'
        platform: ${{ parameters.arch }}
        maximumCpuCount: true
      displayName: 'Build'

    - task: PowerShell@2
      inputs:
        filePath: build\win\test.ps1
        arguments: -configuration Release -arch ${{ parameters.arch }}
        failOnStderr: false
      displayName: 'Test'

    - task: PowerShell@2
      inputs:
        filePath: build\win\release.ps1
        arguments: -arch ${{ parameters.arch }}
      displayName: 'Package'

    - template: package.yml
      parameters:
        contents: 'build\win\libfly-*.zip'
